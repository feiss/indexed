<!-- copyright 2015 Diego F. Goberna http://feiss.be -->
<!DOCTYPE html>
<html>
<head>
<meta charset="utf8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<title>8-bit indexed color in webgl</title>
<style>
html, body {
	margin: 0px;
	width: 100%;
	height: 100%;
	background-color: #000;
	overflow: hidden;
	font-family: monospace;
	color: #777;
}
a{
	color: #444;
}

ul{
	margin: 0;
	padding: 0;
	list-style-position: inside;
}
div{
	margin: 5px 10px;
}
</style>
</head>
<body>
	<canvas id="c"></canvas>
	<div>
		<ul>
			<li>Move mouse around canvas</li>
			<li>[Click] toggle palette cycling</li>
			<li>[ 1 ] Clear</li>
			<li>[ 2 ] Next sprite</li>
		</ul>
	<br>
	<br>
	<a href="https://github.com/feiss/indexed">View on GitHub</a></div>


<script src="twgl-full.js"></script>
<script src="indexed.js"></script>
<script>

var W= 320;
var H= 200;


for (var i=10000, lookupTable=[]; i--;) {
	lookupTable.push(Math.random()*3|0);
}
var zzz=0;
function lookup() {
	return ++zzz >= lookupTable.length ? lookupTable[zzz=0] : lookupTable[zzz];
}

var fb= new Buffer(W, H);

function updateFB(){
	for (var i = 0; i < W*H; i++) {
		fb.data[i]= 20;// Math.floor(i/W/H*17)+lookup();
	}
	for (var i = 0; i < 256; i++) {
		fb.data[i]= i;
		fb.data[W+i]= i;
	}
}
updateFB();

var sx=0, sy=0;


document.getElementById('c').addEventListener('mousemove', function(ev){
	sx= Math.floor(ev.clientX/stage.scale-testsprite.width/2);
	sy= Math.floor(ev.clientY/stage.scale-testsprite.height/2);
});
document.getElementById('c').addEventListener('mousedown', function(ev){
	cycling= !cycling;
});

var curritem= 0;
document.addEventListener('keydown', function(ev){
	var list= ['lena','testsprite','o1','grad'];

	//console.log(ev.keyCode);
	switch(ev.keyCode){
		case 49: 
			stage.setPalette(testsprite.palette);
			stage.fb.set(0);
			cycling= false;
		break;
		case 50: 
			curritem= (curritem+1) % list.length;
			testsprite= new Buffer(assets[list[curritem]+'.pcx']);
			console.log(testsprite);
			stage.setPalette(testsprite.palette);
		break;

	}
});
var cycling= false;
var starttime= new Date().getTime();
var frames= 0;
var time= 0;
function render(dt) {
	time= dt;
	
	stage.fb.draw(glue,0,0);
	stage.fb.draw(testsprite, sx, sy);

	if (cycling){
		stage.palette.cycle(0,254);
		stage.updatePalette();
	}
	stage.flip();

	frames++;
	if (frames==60*10){
		console.log('fps: '+ Math.floor( (frames*1000)/(new Date().getTime()-starttime)*10)/10);
		starttime= new Date().getTime();
		frames= 0;
	}
	requestAnimationFrame(render);
}

var stage;

loadAssets([
	'res/testsprite.pcx', 'res/lena.pcx',
	'res/o1.pcx', 'res/grad.pcx', 'res/glue.pcx'
	],
	function(){
		stage= new Stage('c', W, H, 2, false);
		testsprite= new Buffer(assets['lena.pcx']);
		stage.setPalette(testsprite.palette);
		stage.clear(153);
		glue= new Buffer(assets['glue.pcx']);
		requestAnimationFrame(render);		
	},
	function(progress){
	});


</script>





</body>

</html>


